<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€</title>
    <style>
        .layout {
            width: 500px;
            margin: 0 auto;
            margin-top: 40px;
        }

        .post-image {
            width: 50%;
            height: 50%;
            object-fit: cover;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="layout">
    <table>
        <thead>
        <tr>
            <th>ê¸€ ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ì´ë¯¸ì§€</th>
            <th>ì¢‹ì•„ìš”</th>
        </tr>
        </thead>
        <tbody>
        <!-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
        <tr th:each="post : ${list}">
            <td th:text="${post.id}">1</td>
            <td>
                <a th:text="${post.title}" th:href="@{/post/view(id=${post.id})}"></a>
            </td>
            <td>
                <img th:if="${post.filepath != null and not #lists.isEmpty(post.filepath)}"
                     th:src="@{${post.filepath[0]} + '?t=' + ${#dates.createNow().time}}"
                     class="post-image" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€" />
            </td>
            <td>
                <span class="heart-count" th:text="${post.heartCount}">0</span>
                <button class="heart-button"
                        th:data-post-id="${post.id}"
                        th:text="${isHearted != null and isHearted ? 'â¤ï¸' : 'ğŸ¤'}"></button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div>
        <th:block th:each="page : ${#numbers.sequence(startPage, endPage)}">
            <a th:if="${page != nowPage}" th:href="@{/post/list(page=${page - 1})}" th:text="${page}"></a>
            <strong th:if="${page == nowPage}" th:text="${page}" style="color : red"></strong>
        </th:block>
    </div>
</div>

<script th:inline="javascript">
    $(document).ready(function () {
        const memberId = 1;  // ì„ì‹œ íšŒì› ID

        $(".heart-button").each(function () {
            const button = $(this);
            const postId = button.data("post-id");

            // ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸
            $.get(`/heart/${memberId}/${postId}`, function (isLiked) {
                button.text(isLiked ? "â¤ï¸" : "ğŸ¤");
            });

            // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            button.click(function () {
                if (button.text() === "ğŸ¤") {
                    $.post(`/heart/${memberId}/${postId}`, function () {
                        button.text("â¤ï¸");
                        let count = parseInt(button.siblings(".heart-count").text()) + 1;
                        button.siblings(".heart-count").text(count);
                    }).fail(function () {
                        console.log("ì¢‹ì•„ìš” ì‹¤íŒ¨");
                    });
                } else {
                    $.ajax({
                        type: "DELETE",
                        url: `/heart/${memberId}/${postId}`,
                        success: function () {
                            button.text("ğŸ¤");
                            let count = Math.max(0, parseInt(button.siblings(".heart-count").text()) - 1);
                            button.siblings(".heart-count").text(count);
                        },
                        error: function () {
                            console.log("ì¢‹ì•„ìš” ì·¨ì†Œ ì‹¤íŒ¨");
                        }
                    });
                }
            });
        });
    });
</script>

</body>
</html>